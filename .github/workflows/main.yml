name: Python application 2

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Test with pytest
        run: |
          pytest

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/fibonacci-calculator:1.0.0 .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/fibonacci-calculator:1.0.0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.0.1
          terraform_wrapper: false

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check
        working-directory: terraform
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false -refresh=true
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -input=false -auto-approve
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Get EC2 IP
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: get-ip
        run: |
          IP=$(terraform output -raw instance_public_ip)
          echo "instance_ip=$IP" >> $GITHUB_OUTPUT
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup SSH
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ steps.get-ip.outputs.instance_ip }} >> ~/.ssh/known_hosts

      - name: Deploy application
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          tar -czf app.tar.gz app.py functions.py requirements.txt 2>/dev/null || tar -czf app.tar.gz app.py
          scp -i ~/.ssh/deploy_key app.tar.gz ubuntu@${{ steps.get-ip.outputs.instance_ip }}:/tmp/app.tar.gz
          ssh -i ~/.ssh/deploy_key ubuntu@${{ steps.get-ip.outputs.instance_ip }} << 'EOF'
            set -e
            APP_DIR=/opt/webapp
            sudo mkdir -p $APP_DIR
            sudo chown -R ubuntu:ubuntu $APP_DIR
            tar -xzf /tmp/app.tar.gz -C $APP_DIR
            sudo apt update -y
            sudo apt install -y python3 python3-venv python3-pip
            python3 -m venv $APP_DIR/venv
            source $APP_DIR/venv/bin/activate
            pip install --upgrade pip
            if [ -f $APP_DIR/requirements.txt ]; then pip install -r $APP_DIR/requirements.txt; else pip install flask; fi
            sudo tee /etc/systemd/system/webapp.service > /dev/null << 'UNIT'
            [Unit]
            Description=webapp
            After=network.target
            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/opt/webapp
            Environment=PATH=/opt/webapp/venv/bin
            ExecStart=/opt/webapp/venv/bin/python /opt/webapp/app.py
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
          UNIT
            sudo systemctl daemon-reload
            sudo systemctl enable webapp.service
            sudo systemctl restart webapp.service
          EOF
